<div class="flex h-screen bg-[#09090b] text-zinc-100 font-sans overflow-hidden">
  
  <aside class="hidden md:flex flex-col w-64 border-r border-zinc-800 bg-zinc-950 p-6">
    <div class="flex items-center gap-3 mb-10 px-2">
      <div class="w-8 h-8 bg-lime-400 rounded-lg flex items-center justify-center text-black">
        <i class="bi bi-soundwave text-lg"></i>
      </div>
      <h1 class="text-xl font-bold tracking-tighter uppercase">Audio<span class="text-lime-400">Flow</span></h1>
    </div>

    <nav class="flex-1 space-y-2">
      <a routerLink="/" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-zinc-900 text-lime-400 font-semibold transition-all">
        <i class="bi bi-house-door-fill"></i>
        <span>Library</span>
      </a>
      <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-xl text-zinc-400 hover:bg-zinc-900 hover:text-zinc-100 transition-all">
        <i class="bi bi-search"></i>
        <span>Search</span>
      </a>
      <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-xl text-zinc-400 hover:bg-zinc-900 hover:text-zinc-100 transition-all">
        <i class="bi bi-heart"></i>
        <span>Favorites</span>
      </a>
    </nav>

    <div class="mt-auto">
      <a routerLink="/add-track"
        class="flex items-center justify-center gap-2 w-full py-3 bg-lime-400 text-black font-bold rounded-xl hover:bg-lime-300 transition-all active:scale-95">
        <i class="bi bi-plus-lg"></i>
        <span>Add Track</span>
      </a>
    </div>
  </aside>

  <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
    
    <header class="flex items-center justify-between px-8 py-6 bg-[#09090b]/80 backdrop-blur-md sticky top-0 z-30">
      <div>
        <h2 class="text-2xl font-bold tracking-tight">Ma Collection</h2>
        <p class="text-zinc-500 text-xs uppercase tracking-widest mt-1">Cloud Library</p>
      </div>

      <div class="flex items-center gap-4">
        <div class="relative group">
          <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></i>
          <input type="text" 
            [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)"
            placeholder="Search titles, artists..."
            class="pl-10 pr-4 py-2 bg-zinc-900 border border-zinc-800 rounded-full text-sm focus:ring-2 focus:ring-lime-400/20 focus:border-lime-400 outline-none w-64 transition-all">
        </div>
        
        <div class="relative">
          <select [ngModel]="selectedFilter()" (ngModelChange)="selectedFilter.set($event)"
            class="pl-4 pr-10 py-2 bg-zinc-900 border border-zinc-800 rounded-full text-sm appearance-none cursor-pointer focus:border-lime-400 outline-none">
            <option value="Tout">All Genres</option>
            <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
          </select>
          <i class="bi bi-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 text-[10px]"></i>
        </div>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto px-8 pb-40 scrollbar-hide">
      
      @if (loading$ | async) {
        <div class="flex flex-col items-center justify-center h-64">
          <div class="w-8 h-8 border-2 border-lime-400/20 border-t-lime-400 rounded-full animate-spin"></div>
        </div>
      } @else {
        
        @if (filteredTracks().length > 0) {
          <div cdkDropList cdkDropListOrientation="mixed" (cdkDropListDropped)="drop($event)"
            class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">

            @for (track of filteredTracks(); track track.id) {
              <div cdkDrag [cdkDragDisabled]="searchQuery() !== '' || selectedFilter() !== 'Tout'"
                class="group relative bg-zinc-900/40 p-4 rounded-2xl border border-zinc-800/50 hover:bg-zinc-900 hover:border-zinc-700 transition-all duration-300">
                
                <div class="relative aspect-square mb-4 rounded-xl overflow-hidden shadow-xl">
                  <img [src]="track.coverUrl || 'assets/images/default-cover.png'" 
                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                    onerror="this.src='assets/images/default-cover.png'">
                  
                  <div (click)="onPlay(track)" class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer">
                    <div class="w-12 h-12 bg-lime-400 text-black rounded-full flex items-center justify-center shadow-lg transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                      @if(playerService.currentTrack()?.id === track.id && playerService.isPlaying()){
                        <i class="bi bi-pause-fill text-2xl"></i>
                      } @else {
                        <i class="bi bi-play-fill text-2xl ml-1"></i>
                      }
                    </div>
                  </div>
                </div>

                <div class="space-y-1">
                  <h3 class="font-bold truncate text-zinc-100" [title]="track.title">{{ track.title }}</h3>
                  <div class="flex justify-between items-center">
                    <p class="text-xs text-zinc-500 truncate">{{ track.artist }}</p>
                    @if(playerService.currentTrack()?.id === track.id && playerService.isPlaying()){
                      <div class="flex gap-0.5 items-end h-3">
                        <div class="w-0.5 bg-lime-400 animate-[bounce_0.8s_infinite] h-1.5"></div>
                        <div class="w-0.5 bg-lime-400 animate-[bounce_1s_infinite] h-3"></div>
                        <div class="w-0.5 bg-lime-400 animate-[bounce_1.2s_infinite] h-2"></div>
                      </div>
                    }
                  </div>
                </div>

                <div class="absolute top-6 right-6 flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-all translate-x-2 group-hover:translate-x-0">
                  <button (click)="deleteTrack(track.id!, $event)" 
                    class="w-8 h-8 bg-black/60 backdrop-blur-md rounded-full flex items-center justify-center text-red-400 hover:bg-red-500 hover:text-white transition-all shadow-lg"
                    title="Delete">
                    <i class="bi bi-trash text-sm"></i>
                  </button>
                  <a [routerLink]="['/edit-track', track.id]" (click)="$event.stopPropagation()" 
                    class="w-8 h-8 bg-black/60 backdrop-blur-md rounded-full flex items-center justify-center text-zinc-300 hover:bg-white hover:text-black transition-all shadow-lg"
                    title="Edit">
                    <i class="bi bi-pencil-square text-sm"></i>
                  </a>
                  <a [routerLink]="['/track', track.id]" (click)="$event.stopPropagation()" 
                    class="w-8 h-8 bg-black/60 backdrop-blur-md rounded-full flex items-center justify-center text-lime-400 hover:bg-lime-400 hover:text-black transition-all shadow-lg"
                    title="Details">
                    <i class="bi bi-info-circle text-sm"></i>
                  </a>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="flex flex-col items-center justify-center py-24 text-center">
             <div class="w-20 h-20 bg-zinc-900 rounded-full flex items-center justify-center mb-4 border border-zinc-800">
               <i class="bi bi-music-note-beamed text-3xl text-zinc-700"></i>
             </div>
             <h3 class="text-xl font-bold">No tracks found</h3>
             <p class="text-zinc-500 mt-2">Adjust your filters or add some new vibes.</p>
          </div>
        }
      }
    </div>
  </main>

  @if (playerService.currentTrack()) {
    <div class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 w-[90%] max-w-4xl">
      <div class="bg-zinc-900/90 backdrop-blur-2xl border border-zinc-800 p-3 pl-4 rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.5)] flex items-center gap-6">
        <div class="flex items-center gap-3 w-1/4 min-w-0">
          <img [src]="playerService.currentTrack()?.coverUrl || 'assets/images/default-cover.png'"
            class="w-12 h-12 rounded-lg object-cover shadow-lg">
          <div class="min-w-0">
            <h4 class="text-sm font-bold truncate text-white leading-tight">{{ playerService.currentTrack()?.title }}</h4>
            <p class="text-[10px] text-zinc-400 truncate uppercase tracking-tighter">{{ playerService.currentTrack()?.artist }}</p>
          </div>
        </div>
        <div class="flex-1 flex flex-col gap-2">
          <div class="flex items-center justify-center gap-6">
            <button (click)="playerService.previous()" class="text-zinc-400 hover:text-white transition-colors"><i class="bi bi-skip-start-fill text-xl"></i></button>
            <button (click)="playerService.togglePlay()" class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition-transform">
              <i class="bi text-xl" [class.bi-pause-fill]="playerService.isPlaying()" [class.bi-play-fill]="!playerService.isPlaying()"></i>
            </button>
            <button (click)="playerService.next()" class="text-zinc-400 hover:text-white transition-colors"><i class="bi bi-skip-end-fill text-xl"></i></button>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-[10px] text-zinc-500 font-mono">{{ playerService.currentTime() | formatTime }}</span>
            <div class="relative flex-1 h-1 bg-zinc-800 rounded-full group cursor-pointer">
              <input type="range" [max]="playerService.duration()" [value]="playerService.currentTime()"
                (input)="onSeek($event)" class="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer">
              <div class="absolute h-full bg-lime-400 rounded-full" [style.width.%]="(playerService.currentTime() / (playerService.duration() || 1)) * 100"></div>
            </div>
            <span class="text-[10px] text-zinc-500 font-mono">{{ playerService.duration() | formatTime }}</span>
          </div>
        </div>
        <div class="hidden sm:flex items-center gap-4 w-1/4 justify-end pr-2">
           <i class="bi bi-volume-up text-zinc-400"></i>
           <input type="range" min="0" max="1" step="0.1" [value]="playerService.volume()" (input)="onVolume($event)"
            class="w-20 h-1 bg-zinc-800 rounded-full appearance-none accent-lime-400">
        </div>
      </div>
    </div>
  }
</div>